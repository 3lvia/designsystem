import * as fs from 'fs';
import * as gulp from 'gulp';
import { getThemeColorContrast, getThemeColor, ColorLabel } from '@elvia/elvis-colors';

/** All the possible labels that can be used as css variables for icon colors. */
export type IconLabels =
  | 'stroke'
  | 'filled-foreground'
  | 'filled-background'
  | 'filled-foreground-colored'
  | 'on'
  | 'caution'
  | 'warning'
  | 'error';
type ColorLabelContrast = `${ColorLabel}--contrast`;
type ColorLabelOrContrast = ColorLabel | ColorLabelContrast;
type ColorLabelOrContrastOrCurrentColor = ColorLabelOrContrast | 'currentColor';
type IconClassToThemeColor = {
  [key: string]: { [label in IconLabels]?: ColorLabelOrContrastOrCurrentColor };
};

/**
 * Used to set all the color css variables in an icon to the colors they should have.
 *
 * Stoke and 'filled-background' are set to the same color as the label, and the
 * 'filled-foreground' is set to the corresponding contrast color.
 */
const defaultLabeledIconWithContrast = (newClassName: ColorLabel): IconClassToThemeColor[string] => ({
  stroke: newClassName,
  'filled-background': newClassName,
  'filled-foreground': `${newClassName}--contrast`,
});

/**
 * Creates css classes in the format: `.e-icon--color-{label}` that set the color of the icon.
 * Different parts of the icon can be set to different colors.
 *
 * E.g. `.e-icon--color-on` sets the color of the icon that is labeled with stroke and 'filled-background' to the `icon-on` color.
 */
const iconClassToThemeColor = {
  inverted: {
    stroke: 'static-white',
    'filled-background': 'static-white',
    'filled-foreground': 'static-black',
  },
  default: {
    stroke: 'icon-stroke',
    'filled-background': 'icon-filled-background',
    'filled-foreground': 'icon-filled-foreground',
    'filled-foreground-colored': 'icon-filled-foreground-colored',
    on: 'icon-on',
    caution: 'icon-caution',
    warning: 'icon-warning',
    error: 'icon-error',
  },
  disabled: {
    stroke: 'state-disabled-foreground',
    'filled-background': 'state-disabled-foreground',
  },
  'disabled-light': {
    stroke: 'state-disabled-foreground-strong',
    'filled-background': 'state-disabled-foreground-strong',
  },
  placeholder: { stroke: 'text-placeholder', 'filled-background': 'text-placeholder' },
  currentColor: {
    stroke: 'currentColor',
    'filled-background': 'currentColor',
  },
  on: defaultLabeledIconWithContrast('icon-on'),
  green: defaultLabeledIconWithContrast('icon-on'),
  caution: defaultLabeledIconWithContrast('icon-caution'),
  yellow: defaultLabeledIconWithContrast('icon-caution'),
  warning: defaultLabeledIconWithContrast('icon-warning'),
  orange: defaultLabeledIconWithContrast('icon-warning'),
  error: defaultLabeledIconWithContrast('icon-error'),
  danger: defaultLabeledIconWithContrast('icon-error'),
  red: defaultLabeledIconWithContrast('icon-error'),
  white: defaultLabeledIconWithContrast('static-white'),
  black: defaultLabeledIconWithContrast('static-black'),
} as const satisfies IconClassToThemeColor;

const WARNING = `// THIS FILE IS AUTOMATICALLY GENERATED AND WILL BE OVERWRITTEN.
// DO NOT MAKE CHANGES TO THIS FILE DIRECTLY.\n\n`;

const colorIsCurrentColor = (color: ColorLabelOrContrastOrCurrentColor): color is 'currentColor' =>
  color === 'currentColor';

const colorIsContrastColor = (color: ColorLabelOrContrast): color is ColorLabelContrast =>
  typeof color === 'string' && color.endsWith('--contrast');

const getScssColors = (colors: IconClassToThemeColor[keyof IconClassToThemeColor]) => {
  let scssColors = '';
  for (const [label, color] of Object.entries(colors)) {
    if (colorIsCurrentColor(color)) {
      scssColors += `'${label}': ${color}, `;
    } else if (colorIsContrastColor(color)) {
      scssColors += `'${label}': ${getThemeColorContrast(color.replace('--contrast', '') as ColorLabel)}, `;
    } else {
      scssColors += `'${label}': ${getThemeColor(color)}, `;
    }
  }
  return scssColors;
};

const generateIconColorClassesMap = () => {
  let fileContent = `$icon-theme-classes: (\n`;
  for (const [label, colors] of Object.entries(iconClassToThemeColor)) {
    if (label === 'inverted') {
      fileContent += `\t'${label}': ( ${getScssColors(colors)} ),\n`;
    } else {
      fileContent += `\t'color-${label}': ( ${getScssColors(colors)} ),\n`;
    }
  }
  fileContent += `);\n\n`;

  return fileContent;
};

const writeIconThemeVariables = async () => {
  const fileContent = WARNING + generateIconColorClassesMap();
  fs.writeFileSync('./dist/scss/themeVariables.scss', fileContent);
  return true;
};

const makeDistFolder = async () => {
  const dir = './dist/scss';
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
  return true;
};

const generateIconsScss = gulp.series(makeDistFolder, writeIconThemeVariables);

export { generateIconsScss };
