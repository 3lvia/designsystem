import * as fs from 'fs';
import * as gulp from 'gulp';
import { getThemeColor, ColorLabel } from '@elvia/elvis-colors';

/** All the possible labels that can be used as css variables for icon colors. */
export type IconLabels =
  | 'stroke'
  | 'foreground'
  | 'filled-foreground'
  | 'filled-background'
  | 'on'
  | 'caution'
  | 'warning'
  | 'error';
type IconClassToThemeColor = {
  [key: string]: { [label in IconLabels]?: ColorLabel };
};
type IconLabelCssVariables = { [label in IconLabels]: ReturnType<typeof getThemeColor> };

/**
 * Creates css variables in the format: `--e-icon-color-{label}: var(--e-color-{color});`
 */
const iconLabelCssVariables: IconLabelCssVariables = {
  stroke: getThemeColor('text-primary'),
  foreground: getThemeColor('background-primary'),
  'filled-foreground': getThemeColor('background-primary'),
  'filled-background': getThemeColor('text-primary'),
  on: getThemeColor('state-on'),
  caution: getThemeColor('state-caution'),
  warning: getThemeColor('state-warning'),
  error: getThemeColor('state-error'),
};

/**
 * Creates css classes in the format: `.e-icon--color-{label}` that set the color of the icon.
 * Different parts of the icon can be set to different colors.
 *
 * E.g. `.e-icon--color-on` sets the color of the icon that is labeled with stroke and 'filled-background' to the `state-on` color.
 */
const iconClassToThemeColor: IconClassToThemeColor = {
  inverted: {
    stroke: 'background-primary',
    foreground: 'text-primary',
    'filled-foreground': 'text-primary',
    'filled-background': 'background-primary',
  },
  disabled: { stroke: 'state-disabled', 'filled-background': 'state-disabled' },
  on: { stroke: 'state-on', 'filled-background': 'state-on' },
  green: { stroke: 'state-on', 'filled-background': 'state-on' },
  caution: { stroke: 'state-caution', 'filled-background': 'state-caution' },
  yellow: { stroke: 'state-caution', 'filled-background': 'state-caution' },
  warning: { stroke: 'state-warning', 'filled-background': 'state-warning' },
  orange: { stroke: 'state-warning', 'filled-background': 'state-warning' },
  error: { stroke: 'state-error', 'filled-background': 'state-error' },
  danger: { stroke: 'state-error', 'filled-background': 'state-error' },
  red: { stroke: 'state-error', 'filled-background': 'state-error' },
};

const WARNING = `// THIS FILE IS AUTOMATICALLY GENERATED AND WILL BE OVERWRITTEN.
// DO NOT MAKE CHANGES TO THIS FILE DIRECTLY.\n\n`;

const generateIconCssVariablesMap = () => {
  let fileContent = `$icon-variables: (\n`;
  for (const [label, color] of Object.entries(iconLabelCssVariables)) {
    fileContent += `\t'${label}': ${color},\n`;
  }
  fileContent += `);\n\n`;

  return fileContent;
};

const getScssColors = (colors: { [label in IconLabels]?: ColorLabel }) => {
  let scssColors = '';
  for (const [label, color] of Object.entries(colors)) {
    scssColors += `'${label}': ${getThemeColor(color)}, `;
  }
  return scssColors;
};

const generateIconColorClassesMap = () => {
  let fileContent = `$icon-theme-classes: (\n`;
  for (const [label, colors] of Object.entries(iconClassToThemeColor)) {
    if (label === 'inverted') {
      fileContent += `\t'${label}': ( ${getScssColors(colors)} ),\n`;
    } else {
      fileContent += `\t'color-${label}': ( ${getScssColors(colors)} ),\n`;
    }
  }
  fileContent += `);\n\n`;

  return fileContent;
};

const writeIconThemeVariables = async () => {
  let fileContent = WARNING;
  fileContent += generateIconCssVariablesMap();
  fileContent += generateIconColorClassesMap();
  fs.writeFileSync('./dist/scss/themeVariables.scss', fileContent);
  return true;
};

const makeDistFolder = async () => {
  const dir = './dist/scss';
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
  return true;
};

const generateIconsScss = gulp.series(makeDistFolder, writeIconThemeVariables);

export { generateIconsScss };
